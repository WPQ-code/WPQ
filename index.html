<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>赣南师范大学-智慧校园 WebGIS</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/openlayers/dist/ol.css"> 
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="/css/GNNU.css">


    <script src="./libs/jquery-1.11.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/openlayers/dist/ol.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./libs/GNNU.js"></script>
</head>

<body onload="init()">

    <div id="map">
        <div id="popup" class="ol-popup">
            <a href="#" id="popup-closer" class="ol-popup-closer">×</a>
            <div id="popup-content"></div>
        </div>
    </div>

    <header class="app-header">
        <div class="brand">
            <img src="./data/images/GNNUicon.png" alt="Logo" onerror="this.style.display='none'">
            <span>赣南师范大学校园设施服务系统</span>
        </div>
    </header>

    <div class="basemap-toolbar">
        <div class="basemap-btn active basemap-card" onclick="changeBaseMap('vec', this)" title="矢量地图"><img src="./data/Layers_img/vector.png" onerror="this.src='https://via.placeholder.com/60?text=Vec'" alt="矢量"><span>矢量</span></div>
        <div class="basemap-btn basemap-card" onclick="changeBaseMap('img', this)" title="影像卫星"><img src="./data/Layers_img/image.png" onerror="this.src='https://via.placeholder.com/60?text=Img'" alt="影像"><span>影像</span></div>
        <div class="basemap-btn basemap-card" onclick="changeBaseMap('ter', this)" title="地形地图"><img src="./data/Layers_img/terrain.png" onerror="this.src='https://via.placeholder.com/60?text=Ter'" alt="地形"><span>地形</span></div>
    </div>

    <div class="left-tools">
        <div class="map-btn" title="放大" onclick="map.getView().setZoom(map.getView().getZoom()+1)"><i class="fas fa-plus"></i></div>
        <div class="map-btn" title="缩小" onclick="map.getView().setZoom(map.getView().getZoom()-1)"><i class="fas fa-minus"></i></div>
        <div class="map-btn" title="复位" onclick="map.getView().animate({zoom:14, center:ol.proj.fromLonLat([114.881, 25.799])})"><i class="fas fa-home"></i></div>
        <div class="map-btn" title="定位" id="btnLocateTrigger" onclick="doLocate()"><i class="fas fa-crosshairs"></i></div>
    </div>

    <div id="sidebarToggle" onclick="toggleSidebar()"><i class="fas fa-chevron-right" id="toggleIcon"></i></div>

    <div class="sidebar" id="sidebar">
        <div class="nav-tabs-custom">
            <div class="nav-item active" onclick="switchTab('layers', this)"><i class="fas fa-layer-group"></i> 图层</div>
            <div class="nav-item" onclick="switchTab('draw', this)"><i class="fas fa-pen-nib"></i> 绘图</div>
            <div class="nav-item" onclick="switchTab('measure', this)"><i class="fas fa-ruler-combined"></i> 测量</div>
            <div class="nav-item" onclick="switchTab('route', this)"><i class="fas fa-route"></i> 路径</div>
            <div class="nav-item" onclick="switchTab('query', this)"><i class="fas fa-search"></i> 查询</div>
        </div>

        <div class="sidebar-content">
            <div id="panel-layers" class="tab-pane active">
                <div class="mb-3"><button id="spotlightBtn" class="btn-custom"><i class="fas fa-search text-primary me-2"></i>开启图层探查</button></div>
                <div class="mb-2">
                    <label class="form-label small text-muted fw-bold">数据加载</label>
                    <button id="addGEOJSON" class="btn-custom" onclick="loadVectData()"><i class="fas fa-map me-2"></i>加载 GNNU 边界</button>
                    <button id="btnBuilding" class="btn-custom" onclick="toggleBuildingLayer()"><i class="fas fa-building me-2 text-warning"></i>加载建筑 (Buildings)</button>
                    <button id="btnRoad" class="btn-custom" onclick="toggleRoadLayer()"><i class="fas fa-road me-2 text-primary"></i>加载道路 (Roads)</button>
                    <button id="btnParking" class="btn-custom" onclick="toggleParkingLayer()"><i class="fas fa-parking me-2 text-danger"></i>加载停车场 (Parking)</button>
                    <button id="btnLakes" class="btn-custom" onclick="toggleLakesLayer()"><i class="fas fa-water me-2 text-info"></i>加载湖面 (Lakes)</button>
                    <button id="btnStore" class="btn-custom" onclick="toggleStoreLayer()"><i class="fas fa-store me-2 text-success"></i>加载商业设施 (Stores)</button>
                </div>
                <div id="layerTreeContainer" class="mt-3 p-2 bg-light rounded" style="display:none;"><b class="small text-muted mb-2 d-block">图层控制</b><ul id="layerTree" class="list-unstyled mb-0 small"></ul></div>
            </div>

            <div id="panel-draw" class="tab-pane">
                <div class="mb-3">
                    <label class="form-label small text-muted">选择绘制类型</label>
                    <select id="drawtype" class="form-select">
                        <option value="Point">🔵 绘制点</option>
                        <option value="LineString">〽️ 绘制线</option>
                        <option value="Polygon">🟦 绘制面</option>
                    </select>
                </div>
                <div class="d-grid gap-2 mb-3">
                    <button id="drawToggleBtn" class="btn btn-primary"><i class="fas fa-pencil-alt me-2"></i>开始绘图</button>
                    <button id="drawLayerToggleBtn" class="btn btn-outline-secondary" onclick="toggleDrawLayerVisibility()"><i class="fas fa-eye me-2"></i>隐藏绘图</button>
                </div>
                <div class="d-grid gap-2">
                    <button id="editToggleBtn" class="btn btn-outline-primary"><i class="fas fa-pen me-2"></i>开启编辑模式</button>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success flex-fill" onclick="saveFeatures()"><i class="fas fa-save"></i> 保存</button>
                        <button class="btn btn-outline-dark flex-fill" onclick="exportDrawnGeoJSON()"><i class="fas fa-file-export"></i> 导出</button>
                    </div>
                    <button class="btn btn-outline-danger" onclick="clearFeatures()"><i class="fas fa-trash-alt me-2"></i>清空画布</button>
                </div>
            </div>

            <div id="panel-measure" class="tab-pane">
                <div class="alert alert-info py-2 small"><i class="fas fa-info-circle"></i> 点击“开始”后在地图上点击绘制，双击结束。</div>
                <div class="mb-3">
                    <label class="form-label small text-muted">测量模式</label>
                    <select id="type" class="form-select">
                        <option value="length">📏 距离测量</option>
                        <option value="area">📐 面积计算</option>
                    </select>
                </div>
                <div class="d-grid gap-2 mb-3">
                    <button id="measureToggle" class="btn btn-primary">开始测量</button>
                    <button id="measureClear" class="btn btn-outline-danger">清除结果</button>
                </div>
            </div>

            <div id="panel-route" class="tab-pane">
                <div class="mb-3">
                    <label class="form-label small text-muted fw-bold"><i class="fas fa-route me-2"></i>最佳路径规划</label>

                    <!-- 起点选择 -->
                    <div class="mb-3">
                        <label class="form-label small mb-2"><i class="fas fa-play-circle text-success me-1"></i>起点选择</label>
                        <div class="row g-2 mb-2">
                            <div class="col-4">
                                <select id="startLayerSelect" class="form-select form-select-sm" onchange="updateStartPointOptions()">
                                    <option value="">选择图层</option>
                                    <option value="building">🏫 校园建筑</option>
                                    <option value="parking">🅿️ 停车场</option>
                                    <option value="lakes">🏞️ 湖面</option>
                                    <option value="store">🏪 商业设施</option>
                                </select>
                            </div>
                            <div class="col-8">
                                <select id="startPointSelect" class="form-select form-select-sm">
                                    <option value="">选择具体位置</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="clearStartPoint()" title="清除起点">
                                <i class="fas fa-times me-1"></i>清除起点
                            </button>
                        </div>
                    </div>

                    <!-- 终点选择 -->
                    <div class="mb-3">
                        <label class="form-label small mb-2"><i class="fas fa-stop-circle text-danger me-1"></i>终点选择</label>
                        <div class="row g-2 mb-2">
                            <div class="col-4">
                                <select id="endLayerSelect" class="form-select form-select-sm" onchange="updateEndPointOptions()">
                                    <option value="">选择图层</option>
                                    <option value="building">🏫 校园建筑</option>
                                    <option value="parking">🅿️ 停车场</option>
                                    <option value="lakes">🏞️ 湖面</option>
                                    <option value="store">🏪 商业设施</option>
                                </select>
                            </div>
                            <div class="col-8">
                                <select id="endPointSelect" class="form-select form-select-sm">
                                    <option value="">选择具体位置</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="clearEndPoint()" title="清除终点">
                                <i class="fas fa-times me-1"></i>清除终点
                            </button>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="d-grid gap-2 mb-3">
                        <button class="btn btn-success" onclick="calculateRoute()" id="calculateRouteBtn">
                            <i class="fas fa-route me-2"></i>计算最佳路径
                        </button>
                        <button class="btn btn-outline-danger" onclick="clearRoute()" id="clearRouteBtn">
                            <i class="fas fa-trash me-2"></i>清除路径
                        </button>
                    </div>

                    <!-- 路径信息显示 -->
                    <div id="routeInfo" class="alert alert-info py-2 px-3" style="display: none; font-size: 13px;">
                        <div class="d-flex align-items-center mb-1">
                            <i class="fas fa-info-circle me-2"></i><strong>路径信息</strong>
                        </div>
                        <div id="routeDetails"></div>
                    </div>
                </div>
            </div>

            <div id="panel-query" class="tab-pane">
                <div class="mb-3">
                    <label class="form-label small text-muted">属性查询</label>
                    <div class="input-group">
                        <select id="queryLayerSelect" class="form-select border-end-0 bg-light" style="max-width: 120px;" onchange="updateAttributeTable()">
                            <option value="building">校园建筑</option>
                            <option value="road">校园道路</option>
                            <option value="parking">停车场</option>
                            <option value="lakes">湖面</option>
                            <option value="store">商业设施</option>
                        </select>
                        <input type="text" id="queryInput" class="form-control border-start-0" placeholder="关键字...">
                        <button class="btn btn-primary" onclick="queryByAttribute()"><i class="fas fa-search"></i></button>
                    </div>
                    <div id="attributeTable" class="attr-table-container"><div class="p-3 text-center text-muted small">请先加载数据，并选择图层查看属性</div></div>
                </div>
                <hr class="my-3 text-muted">
                <div class="mb-3">
                    <label class="form-label small text-muted fw-bold"><i class="fas fa-search-location me-2"></i>空间查询</label>
                    <div class="d-flex gap-2 mb-2">
                        <button class="btn btn-primary btn-sm flex-fill" onclick="activeSpatialQuery('Box')" title="按矩形框选查询"><i class="far fa-square me-1"></i>框选</button>
                        <button class="btn btn-primary btn-sm flex-fill" onclick="activeSpatialQuery('Polygon')" title="按多边形查询"><i class="fas fa-draw-polygon me-1"></i>多边形</button>
                        <button class="btn btn-outline-danger btn-sm" onclick="clearQuery()" title="清空查询结果"><i class="fas fa-trash"></i></button>
                    </div>
                    <div id="queryResultsContainer" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: #fafafa; display: none;">
                        <table id="queryResultsTable" class="attr-table" style="font-size: 12px;">
                            <thead>
                                <tr>
                                    <th style="width: 30px;">#</th>
                                    <th style="width: 80px;">图层</th>
                                    <th>属性</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted fw-bold"><i class="fas fa-fire text-danger me-2"></i>设施热力图</label>
                    <div class="d-flex gap-2 align-items-center">
                        <select id="heatmapLayerSelect" class="form-select form-select-sm">
                            <option value="all">全部设施</option>
                            <option value="building">校园建筑</option>
                            <option value="road">校园道路</option>
                            <option value="parking">停车场</option>
                            <option value="lakes">湖面</option>
                            <option value="store">商业设施</option>
                        </select>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" id="heatmapSwitch" onchange="toggleHeatmap()">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted fw-bold"><i class="fas fa-chart-pie me-2"></i>统计图表</label>
                    <div class="row g-2 mb-2">
                        <div class="col-12">
                            <select id="statisticLayerSelect" class="form-select form-select-sm" onchange="updateStatisticFields()">
                                <option value="">无</option>
                                <option value="building">校园建筑</option>
                                <option value="road">校园道路</option>
                                <option value="parking">停车场</option>
                                <option value="lakes">湖面</option>
                                <option value="store">商业设施</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="form-label small mb-1">X轴字段 (分类)</label>
                            <select id="statisticXAxisSelect" class="form-select form-select-sm">
                                <option value="">选择X轴字段</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small mb-1">Y轴字段 (数值)</label>
                            <select id="statisticYAxisSelect" class="form-select form-select-sm">
                                <option value="">选择Y轴字段</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-12">
                            <label class="form-label small mb-1">聚合方式</label>
                            <select id="statisticAggregationSelect" class="form-select form-select-sm">
                                <option value="count">计数</option>
                                <option value="sum">求和</option>
                                <option value="avg">平均值</option>
                                <option value="max">最大值</option>
                                <option value="min">最小值</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="showStatistics()"><i class="fas fa-chart-pie me-2"></i>生成统计图表</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <i class="fas fa-map-marker-alt bar-icon"></i>
        <span id="mouse-position"></span>
        <div id="scale-line-container"></div>
    </div>  

    <!-- 图例控件 -->
    <div id="legendControl" class="legend-control">
        <div class="legend-title">图例</div>
        <div id="legendItems"></div>
    </div>

    <div class="modal fade" id="exportModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header py-2"><h6 class="modal-title fw-bold">导出数据</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><select id="featurePicker" class="form-select" size="5"></select></div><div class="modal-footer p-2"><button type="button" class="btn btn-primary btn-sm w-100" onclick="doExportSelected()">确定</button></div></div></div></div>
    <div class="modal fade" id="chartModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title">统计图表</h6>
                    <div id="chartTypeButtons" style="display: none; gap: 5px;">
                        <button class="btn btn-sm btn-outline-primary chart-type-btn" data-type="bar"><i class="fas fa-chart-bar me-1"></i>柱状图</button>
                        <button class="btn btn-sm btn-outline-primary chart-type-btn" data-type="pie"><i class="fas fa-chart-pie me-1"></i>饼图</button>
                        <button class="btn btn-sm btn-outline-primary chart-type-btn" data-type="line"><i class="fas fa-chart-line me-1"></i>折线图</button>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="echartsContainer" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleSidebar() { var s=document.getElementById('sidebar'),b=document.getElementById('sidebarToggle'),i=document.getElementById('toggleIcon'); s.classList.toggle('collapsed'); b.classList.toggle('collapsed'); i.className=s.classList.contains('collapsed')?'fas fa-chevron-left':'fas fa-chevron-right'; }
        function switchTab(t,e) { document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active')); e.classList.add('active'); document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active')); document.getElementById('panel-'+t).classList.add('active'); if(t==='query'&&window.updateAttributeTable) window.updateAttributeTable(); }
        document.getElementById('popup-closer').onclick=function(){document.getElementById('popup').style.display='none';return false;};
    </script>
</body>
</html>