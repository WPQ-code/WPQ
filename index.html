<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ£å—å¸ˆèŒƒå¤§å­¦ - æ™ºæ…§æ ¡å›­ WebGIS</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/openlayers/dist/ol.css"> 
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
        /* --- 1. å…¨å±€ä¸å¸ƒå±€ --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; }
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #e9ecef; }
        
        /* éšè—å¤šä½™æ§ä»¶ */
        .ol-zoom, .ol-attribution { display: none !important; }

        /* --- 2. åº•éƒ¨çŠ¶æ€æ  (å¼ºåˆ¶å¸ƒå±€ä¿®å¤) --- */
        .bottom-bar {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 30px; 
            background: rgba(255,255,255,0.95);
            display: flex; 
            align-items: center; 
            padding: 0 15px; 
            z-index: 1000;
            border-top: 1px solid #ddd; 
            font-size: 11px; color: #333;
            gap: 10px;
        }
        
        /* å¼ºåˆ¶å…ƒç´ é¡ºåºå’Œæ ·å¼ */
        .bar-icon { 
            margin-right: 5px; 
            color: #4576c1;
            flex-shrink: 0;
        }
        
        /* åæ ‡å®¹å™¨ï¼šå¼ºåˆ¶ä¸æµ®åŠ¨ï¼Œå›ºå®šå®½åº¦ */
        #mouse-position, .ol-mouse-position { 
            font-family: monospace; 
            font-weight: bold; 
            min-width: 150px !important;
            flex-shrink: 0;
            position: static !important; /* è¦†ç›– OL é»˜è®¤æ ·å¼ */
            float: none !important;
            background: transparent !important;
            top: auto !important;
            right: auto !important;
            bottom: auto !important;
            left: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            line-height: 1;
        }
        
        /* æ¯”ä¾‹å°ºå®¹å™¨ */
        #scale-line-container { 
            display: flex; 
            align-items: center;
            flex-shrink: 0;
        }
        
        /* ç‰ˆæƒæ–‡å­—ï¼šè‡ªåŠ¨æ¨åˆ°æœ€å³ */
        .bar-text { 
            margin-left: auto; 
            color: #666; 
            flex-shrink: 0;
        }

        /* è¦†å†™ OpenLayers æ¯”ä¾‹å°ºæ ·å¼ */
        .ol-scale-line { 
            position: static !important; 
            background: transparent !important; 
            padding: 0 !important; 
            bottom: auto !important; 
            left: auto !important;
            right: auto !important;
            top: auto !important;
            margin: 0 !important;
        }
        .ol-scale-line-inner { 
            border: 1px solid #5679ae !important; 
            border-top: none !important; 
            color: #5679ae !important; 
            font-size: 8px !important; 
            font-weight: 600; 
            line-height: 1; 
            margin-bottom: 2px; 
        }

        /* --- 3. é¹°çœ¼ (å·¦ä¸‹è§’) --- */
        .ol-overviewmap {
            left: 10px !important; right: auto !important; bottom: 35px !important;
            z-index: 998 !important; background: #fff; padding: 1px; 
            border-radius: 4px; box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        /* --- 4. å›¾ä¾‹æ§ä»¶ --- */
        .legend-control {
            position: absolute;
            left: 180px; /* åœ¨é¹°çœ¼å³ä¾§ */
            bottom: 38px; /* ä¸é¹°çœ¼åŒé«˜ */
            z-index: 999;
            background: rgba(192, 214, 240, 0.95);
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            padding: 10px;
            max-width: 300px; /* å¢åŠ å®½åº¦ä»¥æ”¯æŒä¸¤åˆ— */
            display: none; /* é»˜è®¤éšè— */
            font-size: 12px;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .legend-items-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            flex: 0 0 calc(50% - 6px); /* ä¸¤åˆ—å¸ƒå±€ */
            min-width: 0; /* é˜²æ­¢flexå­é¡¹æº¢å‡º */
        }
        .legend-symbol {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .legend-label {
            color: #555;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- 4. å¼¹çª—æ ·å¼ --- */
        .ol-popup { position: absolute; background-color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border-radius: 6px; border: 1px solid #ccc; bottom: 12px; left: -50px; min-width: 280px; z-index: 2000; display: none; }
        .ol-popup-closer { text-decoration: none; position: absolute; top: 10px; right: 12px; color: #999; font-size: 18px; font-weight: bold; z-index: 2002; }
        .popup-header { padding: 10px 15px; border-bottom: 1px solid #ddd; color: #198754; font-weight: bold; font-size: 15px; background-color: #fff; border-radius: 6px 6px 0 0; display: flex; align-items: center; }
        .popup-body { padding: 0; max-height: 300px; overflow-y: auto; }
        .custom-table { width: 100%; margin-bottom: 0; font-size: 13px; border-collapse: collapse; }
        .custom-table td { padding: 8px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .custom-table tr:nth-child(even) { background-color: #f8f9fa; }
        .label-col { color: #666; width: 35%; }
        .value-col { font-weight: 600; color: #333; }

        /* --- 5. UIç»„ä»¶ --- */
        .app-header { position: absolute; top: 20px; left: 20px; height: 48px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; display: flex; align-items: center; padding: 0 25px; }
        .brand img { height: 28px; width: auto; margin-right: 8px; }
        .brand { font-size: 16px; font-weight: 700; color: #333; display: flex; align-items: center; }
        .basemap-toolbar { position: absolute; top: 80px; left: 20px; z-index: 1000; display: flex; gap: 8px; }
        .basemap-btn { width: 60px; height: 60px; border-radius: 8px; overflow: hidden; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #fff; transition: all 0.2s; position: relative; }
        .basemap-btn img { width: 100%; height: 100%; object-fit: cover; }
        .basemap-btn span { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: #fff; font-size: 10px; text-align: center; }
        .basemap-btn.active { border-color: #0d6efd; box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.3); }
        .left-tools { position: absolute; top: 160px; left: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 998; }
        .map-btn { width: 40px; height: 40px; background: #fff; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.15); font-size: 18px; color: #555; }
        .map-btn:hover { background: #0d6efd; color: #fff; }
        .sidebar { position: absolute; top: 20px; bottom: 50px; right: 20px; width: 360px; background: rgba(255, 255, 255, 0.98); z-index: 999; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.15); transition: transform 0.3s ease; }
        .sidebar.collapsed { transform: translateX(calc(100% + 30px)); }
        #sidebarToggle { position: absolute; top: 120px; right: 380px; width: 24px; height: 60px; background: #fff; border-radius: 8px 0 0 8px; box-shadow: -2px 0 8px rgba(0,0,0,0.1); z-index: 1000; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #666; transition: right 0.3s ease; }
        #sidebarToggle.collapsed { right: 0; border-radius: 8px 0 0 8px; }
        .nav-tabs-custom { display: flex; background: #f8f9fa; border-bottom: 1px solid #eee; border-radius: 8px 8px 0 0; padding: 5px; gap: 5px; }
        .nav-item { flex: 1; text-align: center; padding: 8px 0; cursor: pointer; border-radius: 6px; font-size: 13px; font-weight: 600; color: #666; }
        .nav-item.active { background: #fff; color: #0d6efd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; }
        .tab-pane { display: none; } .tab-pane.active { display: block; }
        .btn-custom { width: 100%; text-align: left; margin-bottom: 8px; padding: 12px 15px; background: #fff; border: 1px solid #ddd; border-radius: 12px; color: #666; height: 50px; display: flex; align-items: center; font-weight: 500; transition: all 0.3s ease; }
        .btn-custom:hover { background: #f5f5f5; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn-custom.active-gnnu { background-color: #28a745; color: white; border-color: #28a745; }
        .btn-custom.active-building { background-color: #ffc107; color: white; border-color: #ffc107; }
        .btn-custom.active-road { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .btn-custom.active-parking { background-color: #dc3545; color: white; border-color: #dc3545; }
        .btn-custom.active-lakes { background-color: #17a2b8; color: white; border-color: #17a2b8; }
        .btn-custom.active-store { background-color: #28a745; color: white; border-color: #28a745; }
        .btn-custom[class*="active-"] i { color: #fff !important; }
        .attr-table-container { max-height: 350px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; margin-top: 10px; background: #fff; }
        
        /* å±æ€§è¡¨æ ·å¼ */
        .attr-table { width: 100%; margin: 0; border-collapse: collapse; font-size: 13px; }
        .attr-table thead { position: sticky; top: 0; z-index: 10; background: #f5f5f5; }
        .attr-table thead th { 
            padding: 12px 8px; 
            text-align: left; 
            font-weight: 600; 
            color: #333; 
            border-bottom: 2px solid #ddd;
            white-space: nowrap;
            border-right: 1px solid #ddd;
        }
        .attr-table thead th:first-child { color: #888; }
        .attr-table tbody tr { border-bottom: 1px solid #eee; }
        .attr-table tbody tr:nth-child(even) { background-color: #fafafa; }
        .attr-table tbody tr:hover { background-color: #f0f5ff; }
        .attr-table tbody td { 
            padding: 10px 8px; 
            vertical-align: middle;
            border-right: 1px solid #eee;
            word-break: break-word;
            max-width: 200px;
        }
        .attr-table tbody tr:hover { cursor: pointer; }

        /* æµ‹é‡ Tooltip */
        .tooltip { position: relative; background: rgba(0, 0, 0, 0.5); border-radius: 4px; color: white; padding: 4px 8px; opacity: 0.7; white-space: nowrap; font-size: 12px; pointer-events: none; }
        .tooltip-measure { opacity: 1; font-weight: bold; }

        /* è·¯å¾„è§„åˆ’æ ·å¼ */
        .route-point { 
            cursor: pointer; 
            transition: all 0.2s ease;
        }
        .route-point:hover { 
            transform: scale(1.1);
        }
        .route-line {
            stroke: #007bff;
            stroke-width: 4;
            stroke-dasharray: 10, 5;
            fill: none;
        }
        .tooltip-static { background-color: #ffcc33; color: black; border: 1px solid white; }
        .tooltip-measure:before, .tooltip-static:before { border-top: 6px solid rgba(0, 0, 0, 0.5); border-right: 6px solid transparent; border-left: 6px solid transparent; content: ""; position: absolute; bottom: -6px; margin-left: -7px; left: 50%; }
        .tooltip-static:before { border-top-color: #ffcc33; }

        #layerTree input[type="checkbox"] { margin-right: 8px; }
        #layerTree li { padding: 5px 0; border-bottom: 1px dashed #eee; display: flex; align-items: center; }
    </style>

    <script src="./libs/jquery-1.11.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/openlayers/dist/ol.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/libs/GNNU.js"></script>
</head>

<body onload="init()">

    <div id="map">
        <div id="popup" class="ol-popup">
            <a href="#" id="popup-closer" class="ol-popup-closer">Ã—</a>
            <div id="popup-content"></div>
        </div>
    </div>

    <header class="app-header">
        <div class="brand">
            <img src="./data/images/GNNUicon.png" alt="Logo" onerror="this.style.display='none'">
            <span>èµ£å—å¸ˆèŒƒå¤§å­¦æ ¡å›­è®¾æ–½æœåŠ¡ç³»ç»Ÿ</span>
        </div>
    </header>

    <div class="basemap-toolbar">
        <div class="basemap-btn active basemap-card" onclick="changeBaseMap('vec', this)" title="çŸ¢é‡åœ°å›¾"><img src="./data/Layers_img/vector.png" onerror="this.src='https://via.placeholder.com/60?text=Vec'" alt="çŸ¢é‡"><span>çŸ¢é‡</span></div>
        <div class="basemap-btn basemap-card" onclick="changeBaseMap('img', this)" title="å½±åƒå«æ˜Ÿ"><img src="./data/Layers_img/image.png" onerror="this.src='https://via.placeholder.com/60?text=Img'" alt="å½±åƒ"><span>å½±åƒ</span></div>
        <div class="basemap-btn basemap-card" onclick="changeBaseMap('ter', this)" title="åœ°å½¢åœ°å›¾"><img src="./data/Layers_img/terrain.png" onerror="this.src='https://via.placeholder.com/60?text=Ter'" alt="åœ°å½¢"><span>åœ°å½¢</span></div>
    </div>

    <div class="left-tools">
        <div class="map-btn" title="æ”¾å¤§" onclick="map.getView().setZoom(map.getView().getZoom()+1)"><i class="fas fa-plus"></i></div>
        <div class="map-btn" title="ç¼©å°" onclick="map.getView().setZoom(map.getView().getZoom()-1)"><i class="fas fa-minus"></i></div>
        <div class="map-btn" title="å¤ä½" onclick="map.getView().animate({zoom:14, center:ol.proj.fromLonLat([114.881, 25.799])})"><i class="fas fa-home"></i></div>
        <div class="map-btn" title="å®šä½" id="btnLocateTrigger" onclick="doLocate()"><i class="fas fa-crosshairs"></i></div>
    </div>

    <div id="sidebarToggle" onclick="toggleSidebar()"><i class="fas fa-chevron-right" id="toggleIcon"></i></div>

    <div class="sidebar" id="sidebar">
        <div class="nav-tabs-custom">
            <div class="nav-item active" onclick="switchTab('layers', this)"><i class="fas fa-layer-group"></i> å›¾å±‚</div>
            <div class="nav-item" onclick="switchTab('draw', this)"><i class="fas fa-pen-nib"></i> ç»˜å›¾</div>
            <div class="nav-item" onclick="switchTab('measure', this)"><i class="fas fa-ruler-combined"></i> æµ‹é‡</div>
            <div class="nav-item" onclick="switchTab('route', this)"><i class="fas fa-route"></i> è·¯å¾„</div>
            <div class="nav-item" onclick="switchTab('query', this)"><i class="fas fa-search"></i> æŸ¥è¯¢</div>
        </div>

        <div class="sidebar-content">
            <div id="panel-layers" class="tab-pane active">
                <div class="mb-3"><button id="spotlightBtn" class="btn-custom"><i class="fas fa-search text-primary me-2"></i>å¼€å¯å›¾å±‚æ¢æŸ¥</button></div>
                <div class="mb-2">
                    <label class="form-label small text-muted fw-bold">æ•°æ®åŠ è½½</label>
                    <button id="addGEOJSON" class="btn-custom" onclick="loadVectData()"><i class="fas fa-map me-2"></i>åŠ è½½ GNNU è¾¹ç•Œ</button>
                    <button id="btnBuilding" class="btn-custom" onclick="toggleBuildingLayer()"><i class="fas fa-building me-2 text-warning"></i>åŠ è½½å»ºç­‘ (Buildings)</button>
                    <button id="btnRoad" class="btn-custom" onclick="toggleRoadLayer()"><i class="fas fa-road me-2 text-primary"></i>åŠ è½½é“è·¯ (Roads)</button>
                    <button id="btnParking" class="btn-custom" onclick="toggleParkingLayer()"><i class="fas fa-parking me-2 text-danger"></i>åŠ è½½åœè½¦åœº (Parking)</button>
                    <button id="btnLakes" class="btn-custom" onclick="toggleLakesLayer()"><i class="fas fa-water me-2 text-info"></i>åŠ è½½æ¹–é¢ (Lakes)</button>
                    <button id="btnStore" class="btn-custom" onclick="toggleStoreLayer()"><i class="fas fa-store me-2 text-success"></i>åŠ è½½å•†ä¸šè®¾æ–½ (Stores)</button>
                </div>
                <div id="layerTreeContainer" class="mt-3 p-2 bg-light rounded" style="display:none;"><b class="small text-muted mb-2 d-block">å›¾å±‚æ§åˆ¶</b><ul id="layerTree" class="list-unstyled mb-0 small"></ul></div>
            </div>

            <div id="panel-draw" class="tab-pane">
                <div class="mb-3">
                    <label class="form-label small text-muted">é€‰æ‹©ç»˜åˆ¶ç±»å‹</label>
                    <select id="drawtype" class="form-select">
                        <option value="Point">ğŸ”µ ç»˜åˆ¶ç‚¹</option>
                        <option value="LineString">ã€½ï¸ ç»˜åˆ¶çº¿</option>
                        <option value="Polygon">ğŸŸ¦ ç»˜åˆ¶é¢</option>
                    </select>
                </div>
                <div class="d-grid gap-2 mb-3">
                    <button id="drawToggleBtn" class="btn btn-primary"><i class="fas fa-pencil-alt me-2"></i>å¼€å§‹ç»˜å›¾</button>
                    <button id="drawLayerToggleBtn" class="btn btn-outline-secondary" onclick="toggleDrawLayerVisibility()"><i class="fas fa-eye me-2"></i>éšè—ç»˜å›¾</button>
                </div>
                <div class="d-grid gap-2">
                    <button id="editToggleBtn" class="btn btn-outline-primary"><i class="fas fa-pen me-2"></i>å¼€å¯ç¼–è¾‘æ¨¡å¼</button>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success flex-fill" onclick="saveFeatures()"><i class="fas fa-save"></i> ä¿å­˜</button>
                        <button class="btn btn-outline-dark flex-fill" onclick="exportDrawnGeoJSON()"><i class="fas fa-file-export"></i> å¯¼å‡º</button>
                    </div>
                    <button class="btn btn-outline-danger" onclick="clearFeatures()"><i class="fas fa-trash-alt me-2"></i>æ¸…ç©ºç”»å¸ƒ</button>
                </div>
            </div>

            <div id="panel-measure" class="tab-pane">
                <div class="alert alert-info py-2 small"><i class="fas fa-info-circle"></i> ç‚¹å‡»â€œå¼€å§‹â€ååœ¨åœ°å›¾ä¸Šç‚¹å‡»ç»˜åˆ¶ï¼ŒåŒå‡»ç»“æŸã€‚</div>
                <div class="mb-3">
                    <label class="form-label small text-muted">æµ‹é‡æ¨¡å¼</label>
                    <select id="type" class="form-select">
                        <option value="length">ğŸ“ è·ç¦»æµ‹é‡</option>
                        <option value="area">ğŸ“ é¢ç§¯è®¡ç®—</option>
                    </select>
                </div>
                <div class="d-grid gap-2 mb-3">
                    <button id="measureToggle" class="btn btn-primary">å¼€å§‹æµ‹é‡</button>
                    <button id="measureClear" class="btn btn-outline-danger">æ¸…é™¤ç»“æœ</button>
                </div>
            </div>

            <div id="panel-route" class="tab-pane">
                <div class="mb-3">
                    <label class="form-label small text-muted fw-bold"><i class="fas fa-route me-2"></i>æœ€ä½³è·¯å¾„è§„åˆ’</label>

                    <!-- èµ·ç‚¹é€‰æ‹© -->
                    <div class="mb-3">
                        <label class="form-label small mb-2"><i class="fas fa-play-circle text-success me-1"></i>èµ·ç‚¹é€‰æ‹©</label>
                        <div class="row g-2 mb-2">
                            <div class="col-4">
                                <select id="startLayerSelect" class="form-select form-select-sm" onchange="updateStartPointOptions()">
                                    <option value="">é€‰æ‹©å›¾å±‚</option>
                                    <option value="building">ğŸ« æ ¡å›­å»ºç­‘</option>
                                    <option value="parking">ğŸ…¿ï¸ åœè½¦åœº</option>
                                    <option value="lakes">ğŸï¸ æ¹–é¢</option>
                                    <option value="store">ğŸª å•†ä¸šè®¾æ–½</option>
                                </select>
                            </div>
                            <div class="col-8">
                                <select id="startPointSelect" class="form-select form-select-sm">
                                    <option value="">é€‰æ‹©å…·ä½“ä½ç½®</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="clearStartPoint()" title="æ¸…é™¤èµ·ç‚¹">
                                <i class="fas fa-times me-1"></i>æ¸…é™¤èµ·ç‚¹
                            </button>
                        </div>
                    </div>

                    <!-- ç»ˆç‚¹é€‰æ‹© -->
                    <div class="mb-3">
                        <label class="form-label small mb-2"><i class="fas fa-stop-circle text-danger me-1"></i>ç»ˆç‚¹é€‰æ‹©</label>
                        <div class="row g-2 mb-2">
                            <div class="col-4">
                                <select id="endLayerSelect" class="form-select form-select-sm" onchange="updateEndPointOptions()">
                                    <option value="">é€‰æ‹©å›¾å±‚</option>
                                    <option value="building">ğŸ« æ ¡å›­å»ºç­‘</option>
                                    <option value="parking">ğŸ…¿ï¸ åœè½¦åœº</option>
                                    <option value="lakes">ğŸï¸ æ¹–é¢</option>
                                    <option value="store">ğŸª å•†ä¸šè®¾æ–½</option>
                                </select>
                            </div>
                            <div class="col-8">
                                <select id="endPointSelect" class="form-select form-select-sm">
                                    <option value="">é€‰æ‹©å…·ä½“ä½ç½®</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="clearEndPoint()" title="æ¸…é™¤ç»ˆç‚¹">
                                <i class="fas fa-times me-1"></i>æ¸…é™¤ç»ˆç‚¹
                            </button>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="d-grid gap-2 mb-3">
                        <button class="btn btn-success" onclick="calculateRoute()" id="calculateRouteBtn">
                            <i class="fas fa-route me-2"></i>è®¡ç®—æœ€ä½³è·¯å¾„
                        </button>
                        <button class="btn btn-outline-danger" onclick="clearRoute()" id="clearRouteBtn">
                            <i class="fas fa-trash me-2"></i>æ¸…é™¤è·¯å¾„
                        </button>
                    </div>

                    <!-- è·¯å¾„ä¿¡æ¯æ˜¾ç¤º -->
                    <div id="routeInfo" class="alert alert-info py-2 px-3" style="display: none; font-size: 13px;">
                        <div class="d-flex align-items-center mb-1">
                            <i class="fas fa-info-circle me-2"></i><strong>è·¯å¾„ä¿¡æ¯</strong>
                        </div>
                        <div id="routeDetails"></div>
                    </div>
                </div>
            </div>

            <div id="panel-query" class="tab-pane">
                <div class="mb-3">
                    <label class="form-label small text-muted">å±æ€§æŸ¥è¯¢</label>
                    <div class="input-group">
                        <select id="queryLayerSelect" class="form-select border-end-0 bg-light" style="max-width: 120px;" onchange="updateAttributeTable()">
                            <option value="building">æ ¡å›­å»ºç­‘</option>
                            <option value="road">æ ¡å›­é“è·¯</option>
                            <option value="parking">åœè½¦åœº</option>
                            <option value="lakes">æ¹–é¢</option>
                            <option value="store">å•†ä¸šè®¾æ–½</option>
                        </select>
                        <input type="text" id="queryInput" class="form-control border-start-0" placeholder="å…³é”®å­—...">
                        <button class="btn btn-primary" onclick="queryByAttribute()"><i class="fas fa-search"></i></button>
                    </div>
                    <div id="attributeTable" class="attr-table-container"><div class="p-3 text-center text-muted small">è¯·å…ˆåŠ è½½æ•°æ®ï¼Œå¹¶é€‰æ‹©å›¾å±‚æŸ¥çœ‹å±æ€§</div></div>
                </div>
                <hr class="my-3 text-muted">
                <div class="mb-3">
                    <label class="form-label small text-muted fw-bold"><i class="fas fa-search-location me-2"></i>ç©ºé—´æŸ¥è¯¢</label>
                    <div class="d-flex gap-2 mb-2">
                        <button class="btn btn-primary btn-sm flex-fill" onclick="activeSpatialQuery('Box')" title="æŒ‰çŸ©å½¢æ¡†é€‰æŸ¥è¯¢"><i class="far fa-square me-1"></i>æ¡†é€‰</button>
                        <button class="btn btn-primary btn-sm flex-fill" onclick="activeSpatialQuery('Polygon')" title="æŒ‰å¤šè¾¹å½¢æŸ¥è¯¢"><i class="fas fa-draw-polygon me-1"></i>å¤šè¾¹å½¢</button>
                        <button class="btn btn-outline-danger btn-sm" onclick="clearQuery()" title="æ¸…ç©ºæŸ¥è¯¢ç»“æœ"><i class="fas fa-trash"></i></button>
                    </div>
                    <div id="queryResultsContainer" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: #fafafa; display: none;">
                        <table id="queryResultsTable" class="attr-table" style="font-size: 12px;">
                            <thead>
                                <tr>
                                    <th style="width: 30px;">#</th>
                                    <th style="width: 80px;">å›¾å±‚</th>
                                    <th>å±æ€§</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted fw-bold"><i class="fas fa-fire text-danger me-2"></i>è®¾æ–½çƒ­åŠ›å›¾</label>
                    <div class="d-flex gap-2 align-items-center">
                        <select id="heatmapLayerSelect" class="form-select form-select-sm">
                            <option value="all">å…¨éƒ¨è®¾æ–½</option>
                            <option value="building">æ ¡å›­å»ºç­‘</option>
                            <option value="road">æ ¡å›­é“è·¯</option>
                            <option value="parking">åœè½¦åœº</option>
                            <option value="lakes">æ¹–é¢</option>
                            <option value="store">å•†ä¸šè®¾æ–½</option>
                        </select>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" id="heatmapSwitch" onchange="toggleHeatmap()">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted fw-bold"><i class="fas fa-chart-pie me-2"></i>ç»Ÿè®¡å›¾è¡¨</label>
                    <div class="row g-2 mb-2">
                        <div class="col-12">
                            <select id="statisticLayerSelect" class="form-select form-select-sm" onchange="updateStatisticFields()">
                                <option value="">æ— </option>
                                <option value="building">æ ¡å›­å»ºç­‘</option>
                                <option value="road">æ ¡å›­é“è·¯</option>
                                <option value="parking">åœè½¦åœº</option>
                                <option value="lakes">æ¹–é¢</option>
                                <option value="store">å•†ä¸šè®¾æ–½</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="form-label small mb-1">Xè½´å­—æ®µ (åˆ†ç±»)</label>
                            <select id="statisticXAxisSelect" class="form-select form-select-sm">
                                <option value="">é€‰æ‹©Xè½´å­—æ®µ</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small mb-1">Yè½´å­—æ®µ (æ•°å€¼)</label>
                            <select id="statisticYAxisSelect" class="form-select form-select-sm">
                                <option value="">é€‰æ‹©Yè½´å­—æ®µ</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-12">
                            <label class="form-label small mb-1">èšåˆæ–¹å¼</label>
                            <select id="statisticAggregationSelect" class="form-select form-select-sm">
                                <option value="count">è®¡æ•°</option>
                                <option value="sum">æ±‚å’Œ</option>
                                <option value="avg">å¹³å‡å€¼</option>
                                <option value="max">æœ€å¤§å€¼</option>
                                <option value="min">æœ€å°å€¼</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="showStatistics()"><i class="fas fa-chart-pie me-2"></i>ç”Ÿæˆç»Ÿè®¡å›¾è¡¨</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <i class="fas fa-map-marker-alt bar-icon"></i>
        <span id="mouse-position"></span>
        <div id="scale-line-container"></div>
    </div>  

    <!-- å›¾ä¾‹æ§ä»¶ -->
    <div id="legendControl" class="legend-control">
        <div class="legend-title">å›¾ä¾‹</div>
        <div id="legendItems"></div>
    </div>

    <div class="modal fade" id="exportModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header py-2"><h6 class="modal-title fw-bold">å¯¼å‡ºæ•°æ®</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><select id="featurePicker" class="form-select" size="5"></select></div><div class="modal-footer p-2"><button type="button" class="btn btn-primary btn-sm w-100" onclick="doExportSelected()">ç¡®å®š</button></div></div></div></div>
    <div class="modal fade" id="chartModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title">ç»Ÿè®¡å›¾è¡¨</h6>
                    <div id="chartTypeButtons" style="display: none; gap: 5px;">
                        <button class="btn btn-sm btn-outline-primary chart-type-btn" data-type="bar"><i class="fas fa-chart-bar me-1"></i>æŸ±çŠ¶å›¾</button>
                        <button class="btn btn-sm btn-outline-primary chart-type-btn" data-type="pie"><i class="fas fa-chart-pie me-1"></i>é¥¼å›¾</button>
                        <button class="btn btn-sm btn-outline-primary chart-type-btn" data-type="line"><i class="fas fa-chart-line me-1"></i>æŠ˜çº¿å›¾</button>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="echartsContainer" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleSidebar() { var s=document.getElementById('sidebar'),b=document.getElementById('sidebarToggle'),i=document.getElementById('toggleIcon'); s.classList.toggle('collapsed'); b.classList.toggle('collapsed'); i.className=s.classList.contains('collapsed')?'fas fa-chevron-left':'fas fa-chevron-right'; }
        function switchTab(t,e) { document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active')); e.classList.add('active'); document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active')); document.getElementById('panel-'+t).classList.add('active'); if(t==='query'&&window.updateAttributeTable) window.updateAttributeTable(); }
        document.getElementById('popup-closer').onclick=function(){document.getElementById('popup').style.display='none';return false;};
    </script>
</body>
</html>